---
title: 将来予測の技術＜M4＞　事後課題レポート例
date: 2015-12-03
author: 西山
---

# 時系列データの変動パターンをみる

モジュール４のテーマは、与えられた時系列データの変動パターンを調べることである。その理由は：

1. 自己回帰分析は将来予測に便利な方法だが、全てのデータに適したやり方ではない。自己回帰分析では精度の高い予測が不可能なデータが存在する。
2. 時系列データの変動パターンに適した予測モデルを選んだうえで、データから推定しなければならない。

この2点にある。

自己回帰分析が不適切な時系列データとは、直近の実績ではなく予測誤差の大小をみながら予測値を修正するという方法が適している、そんなデータである。<font color="red">**自己回帰型**</font>に対して、このような予測モデルを<font color="red">**移動平均型**</font>と呼んでいる。時系列データの中には、自己回帰型でありながら、足元の予測誤差も有用であるような<font color="red">**混合型**</font>も数多くある。

「変動パターンの特徴を調べよ」というのは、データの変動の特徴が「自己回帰型」であるのか、「移動平均型」であるのか、「混合型」であるのかを判別する作業をさす。これを予測モデルの**同定**と呼ぶのだが、そのための主要ツールが<font color="red">**自己相関図**</font>と<font color="red">**偏自己相関図**</font>、この二つのグラフである。

今回の事後課題ではファイル"FiveSeries.RData"に保存されているデータ"data2"から"data5"までの四つが対象である。

```{r load_data}
load(file="FiveSeries.RData")
```

以下、順に調べていくことにする。


## （１）データ２(data2)

### 生（ナマ）のデータ

時系列データを見慣れてくれば、トレンドが含まれているかどうか、プロットするだけで判別がついてくるが、まずはプロットと同時に自己相関図と偏自己相関図を描いて見るのが鉄則である。

```{r plot_data2}
plot(data2)
acf(data2)
pacf(data2)
```

"data2"は、微増・微減を繰り返しながら、全体としては上昇局面、低下局面が交代で現れている。全体として長期増加トレンドがあるようだが明瞭ではない。

さて、ここにどんな変化の特徴が隠れているか？やはり、水準のグラフをみているだけではわからない。時間差をおいて（自己）相関を見る必要がある。

そこで自己相関図をみる。

ところが自己相関図は**高止まり型**をしていて、このままでは『15期もおけば関係はなくなりますね。それまでは、高い水準のあとは高いし、低くなれば低くなる。プラスの相関ですね』、この程度のことしか言えない。

念のために、偏自己相関図も見る。左端がほぼ1である。あとは2期前と3期前が有意のようである。

偏自己相関図の左端がほぼ1ということを大雑把に説明すると、データの自己回帰式は

$$
X_t = a_1 X_{t-1} + a_2 X_{t-2} + a_3 X_{t-3} + \cdots
$$

となるのだが、$X_{t-1}$の係数を1と置けば、目的変数をデータの水準ではなく、データの変化（＝前期差）にして

$$
\Delta X_t = X_t - X_{t-1}= \cdots
$$

このように前期差をとった上で改めて回帰分析にかける方がよいことが示唆されるわけである。

### 前期差

```{r plot_ddata2}
plot(diff(data2))
acf(diff(data2))
pacf(diff(data2))
```

前期差をプロットすると、大体、平均は一定、ばらつきも一定になっており**定常化**されている。

だから自己回帰…、というのは予測をする上では早トチリなのである。自己回帰では予測精度が上がらないデータかもしれない。故に、変化の特徴が自己回帰型であるかどうかをチェックせよ。これが勘所である。

自己回帰型のデータなら**偏自己相関図がカット型**になっていなければならない。そこで、順番を逆にしてもいいので、偏自己相関図からみると、最初の2本が有意に立っていて残りは「誤差の範囲内」としてゼロ。無視できる。これはカット型である。

カット・カットの組み合わせは理論的にない。故に、自己相関図は**減衰型**である必要がある。自己相関図の左端はラグ0の比較で必ず1である。あとは……、全体として減衰型と見てとれる。

<font color="red">
<center>
結論：
</center>

データ２は、前期差を１回だけとったあと、自己相関図が減衰型、偏自己相関図がカット型（スパイク２本）。よって、２次の自己回帰があてはまる。
</font>

## （２）データ３(data3)

### 生（ナマ）のデータ

```{r plot_data3}
plot(data3)
acf(data3)
pacf(data3)
```

"data3"にはトレンドが含まれておらず、平均が一定（横ばい）で、ばらつきも一定（突出や変動範囲の拡大や縮小がない）と言える。

そこで自己相関図をみると、これはカット型である。

カット・カットはありえないので、偏自己相関図は減衰型でなければならない。これを確かめると、これも左端が有意にたっており、カット型に見える。

減衰・減衰はありえるが（混合型）、カット・カットはない。故に、どちらかを減衰型に分類しなければならない。こんな場合は、横軸のラグ期間を長くとるか、（偏）自己相関図を縦に並べて描くと比較しやすい。

```{r plot_data3_long}
acf(data3,lag.max=50)
pacf(data3,lag.max=50)
```

自己相関図より偏自己相関図のほうが減衰型に近い。

<font color="red">
<center>
結論：
</center>

データ３は定常化されており、前期差をとる必要はない。自己相関図がカット型（スパイク１本）、偏自己相関図が減衰型。よって、このデータは自己回帰型ではなく移動平均型 --- 直近の予測誤差によって予測値を修正するという方法が適している（実際の予測作業は次回授業で）
</font>

####【注意】

RStudioで作業していると組み合わせグラフはマージンとの関係でしばしばエラーになって使いにくい。以下の操作はコマンド画面から行うとよい。

```{r eval=FALSE}
par(mfrow=c(2,1))
acf(data3,lag.max=50)
pacf(data3,lag.max=50)
```


## （３）データ４(data4)

上と同じルーティンで分析すればよい。

### 生（ナマ）のデータ

```{r plot_data4}
plot(data4)
```

グラフを見ると、このデータも定常化されている。

（偏）自己相関図の検討に進もう。

```{r acf_data4}
acf(data4)
pacf(data4)
```

偏自己相関図からみよう --- どちらの図から先に見るか、好みがあり一概にいえない。ただ、西山は「自己回帰型で行けるか」を確かめたいという意識もあるので、しばしば偏自己相関図から先にみる。

偏自己相関図は、カット型か、それとも減衰型か…。カット型だとすると、スパイクの大きさが最も大きいラグ４まで入れるしかないだろう。だとすると、４次の自己回帰モデルが当てはまるデータという結論になる。

自己相関図は減衰型になっているかをみる。こちらは分かりやすい減衰型である --- 言葉から憶測はつくと思うが、減衰型ではスパイクの本数を数えることはしない。

<font color="red">
<center>
結論：
</center>

データ４は定常化されており、前期差をとる必要はない。自己相関図が減衰型、偏自己相関図がカット型（スパイクは４本、うち１本は有意でないがラグ４までを含める）。よって、このデータは４次の自己回帰が当てはまる。
</font>


## （４）データ５(data5)

同じ手順で分析する。

### 生（ナマ）のデータ

```{r plot_data5}
plot(data5)
```

前半と後半では平均的な水準に違いがあり、明らかに定常ではない。

故に、前期差をとって変動パターンを調べる必要がある。

生のデータに関する（偏）自己相関図は省略するので、自ら検討しておいてほしい。質問は次回授業で。

### 前期差

```{r plot_ddata5}
plot(diff(data5))
acf(diff(data5))
pacf(diff(data5))
```

1回の前期差で平均やばらつきが定常化される。

このデータの自己相関図はきれいな形をしているので、分類しやすいと思われる。明らかに減衰型である。

となると、自己回帰型か？偏自己相関図をみると、これまた分かりやすい形になっている。カット型で、スパイクは２本である。

<font color="red">
<center>
結論：
</center>

データ５は前期差をとって定常化する必要がある。前期差については、自己相関図が減衰型、偏自己相関図がカット型（スパイクは２本）。よって、このデータは２次の自己回帰が当てはまる。
</font>


#### 【補足】

もしも偏自己相関図も減衰型だったらどうか？その時は、混合型が当てはまる。純粋の自己回帰型でもなく、純粋の移動平均型でもないデータである。混合型と判断する場合は、自己回帰の説明変数にはラグ何期まで含めるかが決まらない。また予測誤差を含めるのも、いつまで遡って含めればよいかが決まらない --- 図を読むことになれてくれば、混合型の場合にも予測モデルの見当がつくのだが、相当の経験を必要とする。最適な予測モデルを自動探索してくれるソフトを使うべきだと、これだけを（今は）述べておく。


