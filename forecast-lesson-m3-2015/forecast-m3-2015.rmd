---
title: 将来予測の技術＜M3＞　事後課題レポート例
date: 2015-11-19
author: 西山
---

# 自己回帰分析で将来予測する


## 航空旅客数の月次データ(1940.1 〜 1960.12)

### (1) データ読み込みと時系列化、データの特徴

データファイルを読み込んだ時のルーティンはもう改めて説明しないが、まだ慣れていないなら以下のコマンドをしっかり確認のこと。

```{r read_data}
data0 <- read.csv(file="passenger.csv")
dim(data0) # データファイルの大きさ
head(data0) # 最初の数行を表示して個別データを確認
```

個別データの"x"が航空旅客数が分析するべき時系列である。これをとり出して名前を"pas"としよう。日付は、1949年1月から1960年12月までである。

```{r to_ts}
pas <- data0$x
pas <- ts(pas,freq=12,start=c(1949,1))
plot(pas)
```

グラフをみると、増加トレンドと季節性が明らかである。

自己回帰分析で変化のパターンを検出するには、まず平均とばらつきを一定の状態にしておくとよい　―　増加トレンドが明らかな場合、そのまま自己回帰分析にかけても『前月の実績から大体▲▲位ずつ増えているようですネ』と、せいぜいそんな結果しか得られないものである。これでは直線トレンドを当てはめる方法と大差はなく、きめ細かい予測はできない。


【補足】それだけではなく、傾向成分の混じった時系列データを自己回帰分析にかけることの問題点は数多くあることが分かっている。

そこで旅客数の前年比をとる。対数の差をとる簡便法を用いよう--- 前年比が10%程度あるので本当は定義通りに前年比を求める方がよいケースではあるが。

具体的には、旅客数の対数をとってから12月以前の値との差をとる。差をとると小数表示の増減率が得られる。更に、100をかけてパーセント値にしておこう。それを"nobi"とする。

```{r to_log}
log.pas <- log(pas)
dlog.pas <- diff(log.pas,12)
nobi <- dlog.pas*100
mean(nobi) # 平均伸び率
plot(nobi)
abline(h=0) # いま描いた図に横軸をひく
abline(h=mean(nobi),lty=2) # 更に、平均伸び率の高さに点線
```

グラフをみると、旅客数を前年比にすると、期間を通して概ね横ばい、上下方向のばらつきも概ね一定範囲におさえられる --- こういう作業を時系列分析では専門用語で**定常化**と呼んでいる。

<font color="red">
**自己回帰分析がシャープにデータの変化に切り込んでいけるのは定常化されていることが前提である。**
</font>

### 自己回帰分析と最適モデルの選択、予測誤差の評価　（学習データ・テストデータ）

最後の1年間を予測性能検証用の**テストデータ**としてとっておき、残りのデータを予測式推定用の**学習データ**として用いる。

```{r window}
nobi.sub <- window(nobi,end=c(1959,12))
nobi.test <- window(nobi,start=c(1960,1))
par(mfrow=c(2,1)) # 2行1列の複数グラフを描く
plot(nobi,main="全データ",xlim=c(1949,1961))
plot(nobi.sub,main="学習データ",xlim=c(1949,1961))
```

上の図は2枚のグラフを縦に二つ並べている。2行目のpar(mfrow=c(2,1))は2行1列のグラフ用紙を広げる指示である。この後、1枚目（上の図）のプロット、2枚目（下の図）のプロットを行う。図を書くときのxlim=c(1949,1961)は横軸の目盛範囲の指示である。こうしないと上下の図で横軸目盛がそろわなくなる。

以下では、2次の自己回帰、最大１２次までの制限をつけた自動探索、制限をつけない自動探索という三つの自己回帰分析を行う。

```{r auto_reg}
kekka1 <- ar(nobi.sub,order.max=2,aic=F)
kekka2 <- ar(nobi.sub,order.max=12,aic=T)
kekka3 <- ar(nobi.sub,aic=T)
kekka1
kekka2
kekka3
```

無制約で予測誤差最小化が期待できる最適予測モデルを探すと、（何と）１３か月以前まで遡って１月先を予測する自己回帰モデルを提案してくるという結果になる。

###（補足）

自己回帰型の予測に限って誤差を最小化しようとすると、このように相当以前まで遡る長い自己回帰式が選ばれてしまうという傾向がある。ボックスジェンキンズ法はこの辺りを改善【?】した方法である（とも言える）。

上のそれぞれの結果を用いてテストデータ期間（1960年1月〜12月）を予測しよう。

#### ◎　kekka1

予測のあと、学習データの実績（実線）、予測ライン（点線）、テストデータ（黒点）の実績を併せてグラフにしよう。

```{r yosoku1}
yosoku1 <- predict(kekka1,n.ahead=12)
ts.plot(nobi.sub,yosoku1$pred,lty=c(1,2))
points(nobi.test,pch=20)
```

変動が大きいので、テストデータは点よりも例えば赤線のほうが良かったかもしれない。とはいえ、2次の自己回帰分析ではテスト期間中の低下をフォローできていない。

#### ◎　kekka3

"kekka1"と"kekka2"は同じ二次の自己回帰であるので、次にkekka3"に基づいて同じ予測をしよう。今度はテストデータを赤線で描く。


```{r yosoku3}
yosoku3 <- predict(kekka3,n.ahead=12)
ts.plot(nobi.sub,yosoku3$pred,lty=c(1,2))
lines(nobi.test,col="red")
```

まあ、方向は合っているが実際に発生した伸び率の急激な低下を事前にはフォローできていないことがわかる。

いずれにせよ、事前予測としては二次の自己回帰による「甘い予測」よりは、まだ１３次という長い自己回帰ではあるが最適予測式を使うほうが良さそうである。

ここで**予測誤差**を評価しておく。

予測誤差を常識的に定義すると以下の式のようになるのではなかろうか。
<center>
予測誤差＝予測値−実績値
</center>
この場合、過大な予測で誤差がプラス、過小な予測で誤差がマイナスに出る。

他方、予測誤差の原因である不規則成分が、その月（期）にどの程度発生したかを推測する。この観点から予測誤差を定義するなら、上の引き算は逆の方がよい。Rの計算では「残差(residual)」という名前で計算結果が保存されるが、これは上とは逆の引き算で得られる値である。この場合は、実績値が予測値を越えれば（いわゆる「上振れ」）、残差（誤差）がプラスに出る。

予測誤差の評価には、通常、**平均二乗誤差(RMSE: Root Mean of Squared Errors)**の大小に着目する。「二乗誤差の平均」と呼ばれるが、実際にはその平方根である --- 統計学でいう「標準偏差」に対応する概念である。

以下の計算は上の常識的な観点から（一先ず）予測誤差を出している。


```{r gosa}
gosa1 <- yosoku1$pred - nobi.test
gosa3 <- yosoku3$pred - nobi.test
gosa1
gosa3
sqrt(mean(gosa1^2)) # kekka1の平均二乗誤差の平方根
sqrt(mean(gosa3^2)) # kekka3による誤差の目安
```

結局は、「誤差の大きさ」の目安を評価するので誤差を求める引き算の順はどちらでもよいことになる。

自己回帰分析の"kekka3"を用いたほうが予測誤差を16%ほど小さくすることができる。とはいえ、前年比予測の誤差が4%程度出るというのは、予測性能として決して満足できる水準ではないかもしれない。

### 将来12カ月予測

予測対象とした1960年1月から12月まではそれまでの高い伸び率にブレーキがかかるいわば「踊り場局面」であった。

状態変化は予測の中でも最も難しい。この点を考慮して、一応、1961年以降について自己回帰分析で予測をしておくことにしよう。

今度は全データを使う。

```{r kekka_all}
kekka.all <- ar(nobi) # aicを略すと自動的にTRUEになる
kekka.all
yosoku.all <- predict(kekka.all,n.ahead=12)
ts.plot(nobi,yosoku.all$pred,lty=c(1,2))
```

図に見るとおり、1961年以降は反転回復が予想される。

#### 【補足１】

通年ではどの程度の増減率見通しになるのか。これも確かめておくとしよう。

月次ベースのデータを集計して四半期化したり年次化したりする作業は時系列データの分析では頻繁に出てくる。こういう時は、コマンドの"aggreagte"を使うのだが、今は1959年（実績）、1960年（実績）、1961年（見通し）を比較するだけなので、以下のように簡単にすませよう。

ただ面倒な個所もある。というのは、まず予測された前年比を用いて1961年の旅客数を求めておかなければならない。しかし、時系列データのままでは日付がついている。そのため単純に
<center>
1961年の旅客数＝（1＋1961年の前年比／100）×1960年の旅客数
</center>
という計算をしようとしても、日付の違うデータどうしを計算しているという理由でエラーになる。

そのため、（まだ予測用パッケージ"forecast"を利用していないので）以下のようにas.numericを使って日付をとってから元の客数を計算する必要がある。「こういうことも出来る」という知識として計算法を紹介しておく。

```{r pas_61}
pas60 <- as.numeric(window(pas,start=c(1960,1),end=c(1960,12)))
pas61 <- (1+as.numeric(yosoku.all$pred)/100)*pas60
pas61 <- ts(pas61,freq=12,start=c(1961,1))
pas61
```

上の結果をつかって以下のように年次ベースの値を出す。

```{r to_year}
nen59 <- sum(window(pas,start=c(1959,1),end=c(1959,12)))
nen60 <- sum(window(pas,start=c(1960,1),end=c(1960,12)))
nen61 <- sum(pas61)
nen59; nen60; nen61 # 月次を合計する結果、「年」はとれた
nen60/nen59; nen61/nen60 # 年ベースの伸び率
```

通年では、1960年並みの増加が1961年にも期待できる。そんな見通しになっていることが分かる。

####　【補足２】

今回、行った自己回帰分析は前年比が通期平均である12%を基準にして、これを上回るか、下回るという変化のパターンを検出するところに目的がある。

ということは、平均を超える値のあとは12%に向かって伸び率が低下していくはずだという理屈になる。もちろん単調に平均に収束していくのではなく、あるパターンに沿って収束するわけである。逆に、低めの伸び率の後は、平均値に向かって戻っていく。そう考えるのが自己回帰分析の勘所である。

自己回帰分析に元々含まれている上のようなロジックは、ボックス・ジェンキンズ法でも（同じ基礎の上に構成されている方法なので）実は一貫することになる。

### ホルトウィンタース法による予測（参考）


念のためホルトウィンタース法で伸び率を予測しておくことにしよう。ホルトウィンタース法は季節成分が含まれているデータにも使えるが、前年比には季節成分はない。その点に注意しながら以下のようにする。

```{r hw}
kekka.hw <- HoltWinters(nobi.sub,gamma=F)
yosoku.hw <- predict(kekka.hw,n.ahead=12)
ts.plot(nobi.sub,yosoku.hw,lty=c(1,2))
```

グラフに見るように、テスト期間についても一貫した増加を予測してしまう --- 誰でも非現実的だと思うだろう。この理由は、直近何カ月かで伸び率の上昇が続いていたので、ホルトウィンタース法に内蔵されている方向修正プロセスが働き、今後も上昇と計算したわけである。

誤差の評価は行わいでおこう。

期間全体を通して平均一定・ばらつき一定を最初に（ある意味で）保証しておき、その前提で変化の法則を検出する自己回帰分析の方が統計理論的には筋が通っていると感じるのではないだろうか。

ただ（ホルトウィンタース法の名誉のために補足しておくと）、前年比をとらない旅客数を予測するときには、マアマアの結果を出す。

```{r hw_pas}
pas.sub <- window(pas,end=c(1959,12))
pas.test <- window(pas,start=c(1960,1))
kekka.hw.pas <- HoltWinters(pas.sub,seasonal="mult")
yosoku.hw.pas <- predict(kekka.hw.pas,n.ahead=12)
ts.plot(pas.sub,yosoku.hw.pas,lty=c(1,2),ylim=c(100,700))
points(pas.test,pch=20,col="red")
```

ホルトウィンタース法で旅客数を予測すると、自己回帰分析とは違って、どうやら過小な予測になったようである --- 数字のチェックは省く。







