---
title: 将来予測の技術＜Ｍ６＞　事後課題レポート例
date: 2017-01-17
author: 西山
---

```{r setup,message=F,warning=F}
library(forecast)
```

# 課題の内容

Ｅラーニング＜テキスト一覧：Ｍ６：データファイル＞フォルダーにアップしている"HousingStart-196501-201508-ByCategory-ExclKyuuyo.csv"(#3)は、（下に一部をコピーしているように）日本の住宅着工戸数のうち「持ち家」(motiie)、「貸家」(kashiya)、「分譲」(bunjou)を保存している。


year | month | motiie | kashiya | bunjou
-----|-------|--------|---------|-------
1965 | 1 | 17614 | 29043 | 3576
1965 | 2 | 22202 | 30213 | 4622
1965 | 3 | 26266 | 28155 | 2385
1965 | 4 | 31984 | 32366 | 3739
1965 | 5 | 30212 | 27534 | 2555
1965 | 6 | 33970 | 31680 | 2879


最終月は2015年8月である。

今回の目的は、翌月（2015年9月）以降1年間の「持ち家」着工戸数の予測である。会議にも配布できる簡潔な資料にまとめよ ― 但し、計算の詳細を参考として書き足してもよい。バランスを考えながら、うまくレポートすること。

以上が前回授業の事後課題であった。

## データの読み込み

```{r read_data}
data0 <- read.csv(file="HousingStart-196501-201508-ByCategory-ExclKyuuyo.csv")
head(data0)
```

ファイル内容から1965年1月を開始月とする月次データであることが分かるので次のように時系列データとする。

```{r to_ts}
motiie <- ts(data0$motiie,freq=12,start=c(1965,1))
kashiya <- ts(data0$kashiya,freq=12,start=c(1965,1))
bunjou <- ts(data0$bunjou,freq=12,start=c(1965,1))
```

「持家」、「貸家」、「分譲」の推移を概括的に見ておこう。

```{r draw_fig1}
ts.plot(motiie,kashiya,bunjou,lty=c(1,2,3),col=c(1,2,3))
```

図にレジェンドは付けていないが、上のコマンドから分かるように黒（色番号１）が持家、赤（色番号２）が貸家、緑（色番号３）が分譲を表している。

> いつでもそうなのだが、元のデータを色々な方向から吟味しながら、作業のプログラムを検討することが大事である。

季節性が顕著のようなので前年比も図にしておく。

```{r draw_fig2}
ts.plot(diff(log(motiie),12),diff(log(kashiya),12),diff(log(bunjou),12),lty=c(1,2,3),col=c(1,2,3))
```

今回は持家を予測したい。これが課題である。ただ、今回は持家のほか、貸家、分譲のデータも利用可能である -- 他のデータも時間をかければもちろん利用できる。

持家着工戸数の変化と貸家、分譲の着工戸数の変化は、関係しあっているようでもあるが、図を見る限り明瞭ではない。

###　更なる吟味

持家については水準が高いときの季節変動が大きく、全体としては乗法モデルが当てはまっているように見える。しかし、持家着工の対数をとっても印象はあまり変わらない。

```{r motiie_log}
plot(motiie)
plot(log(motiie))
```

貸家は持家ほどは季節性が明瞭ではないが、それでも対数をとると季節的なばらつきが一定になるように感じられる。

```{r kashiya_log}
plot(kashiya)
plot(log(kashiya))
```

分譲は、1970年代前半の急増期のあとは概ね一定レベルの動きを示しており、独特な形をしている。対数をとると、更にこの特徴が強調される印象である。

```{r bunjou_log}
plot(bunjou)
plot(log(bunjou))
```

貸家と分譲の二つの着工データが持家の将来予測に有用であるかどうか、直ちには判断できない。

が、いずれによせ持家の季節変動を定常化するのが望ましいので、対数をとったあと更に2000年1月以降のデータだけを分析対象に含めることにしよう。貸家と分譲もその期間だけを含めて、予測に考慮するかしないかを判断することにしよう。

```{r motiie_data}
log.motiie <- log(motiie)
log.motiie <- window(log.motiie,start=c(2000,1))
log.kashiya <- log(kashiya)
log.kashiya <- window(log.kashiya,start=c(2000,1))
log.bunjou <- log(bunjou)
log.bunjou <- window(log.bunjou,start=c(2000,1))
```

2000年1月以降を切り出した上のデータを今回の分析対象とする。念のため、この期間の「持家」、「貸家」、「分譲」の着工戸数を図にしておく（但し、対数にしたあとの数値）。

```{r draw_log_data}
ts.plot(log.motiie,log.kashiya,log.bunjou,lty=c(1,2,3),col=c(1,2,3))
```

## (1) 最も簡単な12カ月予測

> 予測したいデータが決まっているとき、最も簡単な予測法はそのデータに対してauto.arimaを実行することである。複数のデータが利用可能である時もこの事情は同じである。

今回の課題は**持家着工戸数の将来予測**である。予測したい変数が「一変量」であるとき、ボックス・ジェンキンズの方法はいまでも現役、というか定番である。実際には、持家着工戸数は貸家や分譲の着工戸数だけではなく、GDP等に表れるマクロ的な景気、金利から影響を受けるし、更には少子化など人口構造とも関係する。これらのすべてが予測には必要であり、必要な全ての情報を集めてからでなければ持家の予測は出来ないと。こんな風に言い出せば、結局は将来予測は非常に難しい作業になってしまう。所詮は、正確な予測など不可能なことである、とすら言える。

> 先を知りたいというニーズは理想を求めず、現実的に解決するのがよい（これ私見であります）。

予測は、データに含まれている変化のパターンに着目して行う作業である。予測したい変量が、ある要因に影響を受けていて、仮にその要因はまったくランダムに変化しているなら、予測したい変量もまたランダムに変化することになる。あるものが予測できるということは、それに影響している要因もまた特定の変動パターンを持っていることを意味しており、色々な要因の変動パターンはそもそも予測したいと考えている変量に織り込まれているはずだ。この織り込まれているパターンをとり出して、予測作業は進められる。

故に、突き詰めれば持家着工戸数を予測したいなら、持家データだけがあればよい。これが今でもボックス・ジェンキンズ法が現役として利用されている理由である。

したがってスタートとなる予測は次のように普通にやればよい。

```{r yosoku1}
kekka1 <- auto.arima(log.motiie,D=1)
kekka1
yosoku1 <- forecast(kekka1,h=12)
plot(yosoku1)
```

コマンドauto.arimaで"D=1"を指定しているのは、そうしなければ前月差をとってから季節処理をするという計算をするので、これを避けるためである。

この予測モデルのAICは(-464.47)と出ている。

もし持家着工戸数を予測することが目的で、この他に情報がないならば、普通はこれで作業終了としてよい --- もちろん、auto.arimaの自動探索は限定範囲内であるので、もっとAICを小さくする予測モデルが隠れている可能性はある。が、時間と手間をかける限界コストを常に留意するべきだと述べておく。

対数を元の戸数ベースに戻しておく。下の図の点線が予測戸数である。


```{r back_to_kosuu}
yosoku1.kosuu <- exp(yosoku1$mean)
ts.plot(window(motiie,start=c(2000,1)),yosoku1.kosuu,lty=c(1,2))
```

## (2) 持家以外の着工戸数データを考慮した12カ月予測

上で予測した持家着工戸数は、貸家や分譲の着工戸数、その他一切の要因から受ける影響を織り込んだ**持家の変動パターン**に基づいて導き出した予測数値である。

ボックス・ジェンキンズ法による将来予測では、仮に関係のありそうなデータが手元で利用可能であっても、一変量の予測に説明変数を加えることはしないものである。一変量の予測で（わざわざ）説明変数をつけて計算をするのは、ケース分けした予測をしたいとき、あるいは何らかの環境変化の影響を評価してレポートしたいときが多い。

### 貸家をX変量にする

まず貸家との関係を考えて予測モデルをつくろう。

```{r mod_with_kashiya}
kekka2 <- auto.arima(log.motiie,D=1,xreg=log.kashiya)
kekka2
```

今回の推定結果をみると、説明変数に加えた"log.kashiya"の係数が含まれており、標準誤差"s.e."の大きさと比べると有意にきいていることが分かる。またAICは(-508.25)である。目的変数のデータは同じlog.motiieであるのでAICの大小を比較すると、今回のほうが小さい -- 「小さい」というより「低い」というほうが適切かもしれない。

とはいえ、説明変数を含めているので持家を予測するのであれば説明変数である貸家の将来経路も与える必要がある。ここが面倒になる点である。今回のケースでは、将来12か月の貸家着工戸数は分からないので、これを先に予測しておく。それにはARIMAを使えばよい --- いずれにしてもARIMA予測はどこかで必要になることが多い。

```{r fc_kashiya}
mod.kashiya <- auto.arima(log.kashiya,D=1)
yosoku.kashiya <- forecast(mod.kashiya,h=12)
plot(yosoku.kashiya)
```

これで将来の貸家着工が予測値として得られたので、今度は持家の予測でこれを使う。貸家の将来経路を与えるときは中位予測(yosoku.kashiya$mean)をまず与えるのがよい -- 場合によっては、目的に応じて80%下限値などを与えて結果を確認したりする。


```{r fc_motiie_kasi}
yosoku2 <- forecast(kekka2,xreg=yosoku.kashiya$mean)
plot(yosoku2)
```

### 分譲をX変量にする

同じようにして分譲の着工戸数を説明変数にしてみる。

```{r mod_with_bunjou}
kekka3 <- auto.arima(log.motiie,D=1,xreg=log.bunjou)
kekka3
```

今度は推定結果の中にlog.bunjouの係数が含まれる。標準誤差をみると、やはり（明らかに）有意である。ただAICをみると(-478.18)であり、分譲よりは貸家の動向のほうが持家を予測するには役にたちそうである -- このモデルを使った予測計算は省くことにする。

### 貸家と分譲の二つをX変量にする

多くのX変量を含めてやってもよいが、「これは要因としてきいていますね」ということが分かるプラス面がある反面、実際の将来予測でケース分けしようとするときに複雑になるというマイナス面がある。更に、二つの説明変数を入れるなら、説明変数の将来経路も二つ同時に予測計算するべきだという理屈に（本当は）なるのだが、こうなると今回の授業範囲外になってしまう。ここが弱いといえば弱いし、美しくないわけである。

これらの点に注意しながら、一応、やっておくには次のようにする。

```{r mod_with_kashiya_bunjou}
kekka4 <- auto.arima(log.motiie,D=1,xreg=data.frame(log.kashiya,log.bunjou))
kekka4
```

上のように二つのデータをdata.frameで一つにまとめる -- data.frameは予測計算でも使う。

推定結果を見ると、（そんな感じが先の計算でもしたと思うが）分譲は貸家と一緒に入ると有意にきかなくなる。AICは(-507.51)で、貸家だけを含めたモデル"kekka2"のほうが(-508.25)なのでむしろkekka2のほうが良い。ただ持家データだけから持家を予測するよりは他の住宅形態の着工を見ながら予測するほうが精度は高くなりそうである。ここまで言っておいてもよいだろう。

【参考】

参考までに二つの説明変数を含めたときの予測をやっておく。

```{r fc_motiie_both}
mod.kashiya <- auto.arima(log.kashiya,D=1)
fc.kashiya <- forecast(mod.kashiya,h=12)
mod.bunjou <- auto.arima(log.bunjou)
fc.bunjou <- forecast(mod.bunjou,h=12)
new.xreg <- data.frame(log.kashiya=fc.kashiya$mean,log.bunjou=fc.bunjou$mean)
yosoku.both <- forecast(kekka4,xreg=new.xreg)
plot(yosoku.both)
```

二つの説明変数の将来経路の与え方は、上のようにdata.frame（≒データを一つの表にまとめるコマンド）を使えばよいのだが、回帰分析結果を利用したコマンド"predict"でも同じ形で説明変数を与えていたことを記憶しているだろうか -- この辺は色々な予測計算で共通している。

ちなみに上の入力で分譲(log.bunjou)の将来経路を出すためにまず予測モデルを自動で推定しているところ、"D=1"をつけていない。これは"D=1"とすると自動探索途中で「最終解に達しない」という警告が出るためである -- とにかく将来値が必要なので、この辺は仕方がない。

> 結論：持家だけをみて持家着工を予測するより、貸家の動きをみながら、また貸家も予測しながら、持家を予測するほうが予測精度はあがりそうである。これが各予測モデルで得られたAICから言えることである。

## 予測値の比較

持家だけをみて予測した結果(yosoku1)、貸家の動きをみながら持家を予測した結果、この二つを図にしておく。

```{r draw_2case}
ts.plot(log.motiie,yosoku1$mean,yosoku2$mean,lty=c(1,2,2),col=c(1,2,3))
```

実線が2015年8月までの実績、赤い点線が持家データだけによる予測、緑の点線が貸家の動向をみながら予測した経路である。
両者でそれほど大きくは違わないが、貸家の動きを見ながら予測した持家の将来経路のほうが、どちらかと言えば強めに出ている。

> 課題へのレポートの一案としては、2000年1月以降のデータの動きを図にしたうえ、持家だけをみた予測、貸家もみた時の予測について説明するのが簡潔で良いのではなかろうか。

#### 【練習】

上と同じ図を対数ベースでなく戸数ベースで描きなおしてみよ。




