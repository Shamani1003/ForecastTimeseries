---
title: 将来予測の技術＜M2＞　事後課題レポート例
date: 2016-11-01
author: 西山
---

# 時系列の基本成分（TCSI）をみる


## オーストラリアの月次ビール生産量データ

第2回の実習進行シナリオと同じ作業をやっていくことにする。

事後課題で指定されたデータファイルは、グラフを含んだxlsファイルになっている。そのままでは、Rで読み込めない。分析に必要な年、月、数量をCSVファイルとして保存しなおす準備が必要である。

####　データ入力

Rのコマンドでデータファイルを読み込むときのルーティンは以下のとおりである。

まず（必ずしも不可欠というわけではないが）作業用ディレクトリーを所定のフォルダーに移した後、以下の順番で実行する。

1. ファイル一覧でファイル名を確認
2. データファイルを読みこむ。
3. 読み込んだデータの大きさ（行数×列数）を確認
4. 最初の何行かを見る

```{r beginning,hold=TRUE}
dir()
data0 <- read.csv(file="AustralianBeerProduction.csv")
dim(data0)
head(data0)
```

#### 分析したいデータを時系列データ(ts)にする

分析したいデータはビールの生産量である。それに日付をつけて時系列データにするのが第一歩である。変数（＝データ）の名前は、授業時（hs）とは異なって、Volumeを略したvolとしよう（その名称でデータファイルに保存されていた）。もちろん名前の付け方は各自の好みである。


```{r to_ts}
vol <- data0$vol
plot(vol,main="ビール生産量")
vol <- ts(vol,freq=12,start=c(1991,1))
plot(vol)
```

時系列データを図に描くと、自動的に折れ線グラフが選ばれ、横軸には日付が表示される。

大きな季節変動が容易にみてとれる。加法モデルを当てはめてよさそうである。傾向（＝TC成分）はほぼ横ばいである。ノイズ（＝I成分）は・・・、成分分解をしてみないと分からない。

今回は期間も短く、変動の仕方も期間を通じてあまり変わっていない。
一部分を切り取って分析する必要はないと感じられる。


## 直線傾向線（トレンド）の当てはめ

期間を通して微妙に減少傾向があるように思われる。簡単な直線トレンドを回帰分析で当てはめてみよう。

そのため経過時間を表すトレンド変数を作っておく。期間内の月数が56月であるから、1,2,...,56という数字の並びがトレンド変数である。名前はtimeとしておく。timeを説明変数に、volを目的変数にして回帰分析をすればよい。

コマンド"lm"で回帰分析をすると、つけた日付は無視されてしまうので注意する。


```{r reg}
time <- seq(1,56)
keikou <- lm(vol ~ time)
plot(time,vol,type="l")　# 散布図は見づらいのでtype="l"にする
abline(keikou,lty=2)
```


確かにトレンドとしては**低下傾向**になっている。

図の点線部分はT成分である --- 直線を当てはめた以上はC成分は含まれていない --- 故に、回帰直線との開き、つまり残差はCSI成分を表す。

```{r resid}
csi <- residuals(keikou)
plot(time,csi,type="l") 
abline(h=0) # 目盛がゼロの位置に水平線をひく
```

残差にはまだ季節成分が残っていることがみてとれる。

## 移動平均で季節成分を消す

直線トレンドを回帰分析で当てはめる方法は、簡単ではあるが、トレンドの型を最初から直線に前提してもよいかという問題が残る。あくまでも簡便法として使うべきだろう。

これに対して（計算自体はシンプルだが）移動平均法は、季節調整の基礎にもなっており、広く活用されている平滑法である。

移動平均とは、定められた数のデータの平均値を日付に対応させていく方法である。平均計算は単純平均であったり、加重平均であったりする。

それでは、系列"vol"の3か月移動平均を求めよう。移動平均は<font color="red">"filter"</font>コマンドで行う。

```{r ma3,hold=T}
ma3 <- rep(1/3,3)
vol.ma3 <- filter(vol,ma3) # 3個とって平均をとる計算。中止にどう平均
head(vol)
head(vol.ma3)
ts.plot(vol,vol.ma3,lty=c(1,2))
```

コマンド"filter"でsidesを指定しないと**中心移動平均**になる --- 入力時には"side"でもよいし、"s"と略記してもRは実行できる。

いま計算したのは中心移動平均であるので、1991年1月から3月までの最初の3か月の平均値は2月時点の平均値として対応付けられる。従って、最初の月（1991年1月）は欠損値（NA）になる。最終月である1995年8月の移動平均値も同じ理由で欠損値である。

図の実線が元のデータ、点線が３か月移動平均値である。

filterコマンドの括弧内にあるrep(1/3,3)は、分数$1/3$を3個並べた列（＝Rでいうベクトル）を表し、コマンドの意味合いは時系列データを$X_t$として、以下の平均値を求めているわけである。

$$
MA_t = \frac{1}{3}\times X_{t-1} + \frac{1}{3}\times X_{t} + \frac{1}{3}\times X_{t+1}
$$

元データの最初の3項の平均値が移動平均値の1番目の値と一致していることを確かめよ。

上は**中央移動平均**である。つまり3か月分を平均した平均値をとった3月の中央に対応付ける。

これとは別に**後方移動平均**もある。これは、例えば株価の25日移動平均や90日移動平均線という形で利用されている。

```{r ma3_behind}
vol.ma3.kouhou <- filter(vol,ma3,s=1)
head(vol)
head(vol.ma3.kouhou)
tail(vol)
tail(vol.ma3.kouhou)
ts.plot(vol,vol.ma3.kouhou,col=c(1,2))
```

直近3か月がそろわないと平均値を計算できないため最初の二か月は欠損値である。他方、最終月であっても後方移動平均なら計算できる。

後方移動平均は、株価のチャート分析などで多用されているが、その見方には慣れが必要である。後方移動平均の値がそのまま当該時点のトレンドを表しているわけではない。色々な期間で後方移動平均をとって、元データを含めた互いの関係を見ることがチャート分析の勘所である --- たとえば「ゴールデンクロス」という呼び方も複数のグラフの交差の仕方に注目したものである。後方移動平均の利用には注意されたい。

ビール生産量データから季節成分をとりさることにしよう。それには12カ月移動平均をとればよい。しかしながら、偶数項をとった中央移動平均をとると、平均値の対応月が半月ずれてしまう。たとえば偶数である４月移動平均をとると、1月から4月までの平均値が2.5月という時点に対応してしまう。この時点のずれを修正するため2項移動平均を行っておく必要がある。即ち、2段階の移動平均が必要になるのであるが、この計算を1回で行うこともできる。それには、以下のような加重移動平均を実行すればよい。

```{r sa_sub2}
wgt13 <- c(1/24,rep(1/12,11),1/24)　#　13項加重移動平均のウェイト
vol.ma13 <- filter(vol,filter=wgt13,side=2)
ts.plot(vol,vol.ma13,col=c(1,2))
```

式で書くと以下のようになる。元のデータを$X_t$、現時点を$t$時点とする。

$$
MA_t = \frac{1}{24}\times X_{t-6} + \frac{1}{12} \times X_{t-5}
+ \cdots + \frac{1}{12}\times X_{t+5} + \frac{1}{24}\times X_{t+6}
$$


図をみると、13項移動平均によって季節成分が消え去り、平滑化されていることが分かるだろう。なお、13項の移動平均をとっているから、元のデータに含まれていたはずの不規則成分も相互に相殺されているはずである。故に、13項移動平均値は元のデータにあったTC成分、つまり傾向＋循環成分であると解釈できる。

回帰分析で求めた直線トレンドと近い印象である（減少傾向が期間を通してずっと一貫して認められるわけではないが）。

【補足】
ということは、直線トレンドを当てはめた残差がCを含まないSI成分と考え、これを利用して季節成分を取り出しても、マア、よかったことになる。そうすれば、「足元」の直近月（1995年8月）までT、(C)、S、I成分に分解できる見通しも立つが、多分に偶然であり、あまり採らない計算方法であるので、「クイズ」として残しておこう。

【参考】
後方12カ月平均を描いておこう。直近12カ月の平均は足元で上がり始めている。


```{r sankou}
ma12 <- rep(1/12,12)
vol.ma12.kouhou <- filter(vol,ma12,s=1)
ts.plot(vol,vol.ma12.kouhou,col=c(1,2),lty=c(1,2),main="後方12カ月移動平均")
```




##　TC、S、I成分への簡単な分解

以上の計算で**「生（ナマ）のデータ」（＝原系列ないしTCSI）**から**基調**をとり出すことができた。基調とはTC成分である。ただ、いま用いた簡単な方法では**足元**のトレンドを判断できない（欠損値になっているから）。とはいえ、得られたTC成分を原系列から引けばSI成分が得られ、SI成分を（たとえば）3か月移動平均すればI成分を（ほぼ）消してS成分にすることができる。このような簡単な計算法でも、季節性の把握とノイズの平均的な大きさはデータから確認可能である。

が、毎回このような手数をかけるのは面倒である。

コマンド<font color="red">"decompose"</font>は上で述べた計算を一度で実行するので、普通はこちらを使えばよい。

```{r decomp}
bunkai <- decompose(vol)
plot(bunkai)
# どんな結果が計算されたのか。諸々の結果の名前を確認する
names(bunkai)
```

上の成分分解では色々な結果が得られている。最後の<font color="red">"names"</font>コマンドは結果一覧と個別の結果を知りたいときの名称を確認するのに常用する。

たとえば季節成分と不規則成分を確認したいなら次のようにする。

```{r si}
bunkai$seasonal
bunkai$random
```

ここでも<font color="red">結果全体の名前\$個別の結果の名前</font>という風に全体の名称と個別の名前をドル記号(\$)で区切る記法が使われている所をみてほしい --- データをCSVファイルから読んだ時も同じ方式であった。この辺に慣れてくると、Rを使い慣れてきたという感覚が何となくできてくるものである。


